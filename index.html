<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Lease Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      /* ORIX Logo Colors based on provided image */
      --orix-logo-blue: #003366; /* Dark blue from ORIX logo text */
      --orix-logo-red: #E30613;  /* Red from ORIX logo symbol */

      /* General UI Colors, adapted to ORIX theme */
      --orix-white: #FFFFFF;
      --orix-light-grey: #F8FBFD; /* Very light background for contrast */
      --orix-dark-grey: #333333;
      --orix-border-color: #DDEBF5; /* Soft, slightly bluish border */
      --input-bg-editable: #FFFDE1; /* Adjusted: A clear, light yellow for editable inputs */
      --input-bg-readonly: #ECECEC; /* Adjusted: A clear, light grey for readonly inputs */
      --highlight-text-color: var(--orix-logo-blue); /* Emphasize calculated values */
    }

    body {
      font-family: 'Kanit', sans-serif;
      margin: 0;
      padding: 8px; /* Reduced body padding */
      background: var(--orix-light-grey);
      color: var(--orix-dark-grey);
      line-height: 1.4; /* Slightly reduced line height */
      font-size: 1.05em;
    }

    .container {
      max-width: 800px;
      margin: 8px auto; /* Reduced margin around container */
      background: var(--orix-white);
      padding: 15px; /* Reduced container padding */
      border-radius: 10px;
      box-shadow: 0 3px 12px rgba(0, 0, 0, 0.08);
      border: 1px solid var(--orix-border-color);
    }

    h1 {
      text-align: center;
      color: var(--orix-logo-blue);
      margin-bottom: 15px; /* Reduced margin-bottom for h1 */
      font-size: 2.1em; /* Slightly reduced h1 font size */
      font-weight: 600;
    }

    h2 {
      margin-top: 20px; /* Reduced margin-top for h2 */
      margin-bottom: 6px; /* Reduced margin-bottom for h2, very tight */
      color: var(--orix-logo-blue);
      font-size: 1.5em; /* Slightly reduced h2 font size */
      padding-bottom: 5px; /* Still keep a little padding for visual separation */
    }

    table {
      width: 100%;
      margin-bottom: 10px; /* Reduced table margin-bottom */
      border-collapse: separate;
      border-spacing: 0 4px; /* Reduced space between rows, even tighter */
    }

    td {
      padding: 5px 8px; /* Reduced padding for table cells */
      vertical-align: middle;
      border-bottom: none; /* No border-bottom */
    }
    
    table tr:last-child td {
      border-bottom: none;
    }

    td.label {
      width: 45%;
      font-weight: 600;
      color: var(--orix-dark-grey);
    }

    td.value {
      width: 55%;
    }

    td.value input:not([readonly]),
    td.value select {
      width: 100%;
      padding: 7px 10px; /* Reduced input padding */
      border: 1px solid var(--orix-border-color);
      border-radius: 6px;
      background: var(--input-bg-editable);
      color: var(--orix-dark-grey);
      box-sizing: border-box;
      transition: all 0.3s ease;
      text-align: right;
      font-size: 1.0em; /* Slightly reduced input font size */
    }

    td.value input#carInfo {
      text-align: left;
    }

    td.value input#termYears,
    td.value input#comPercent {
      -moz-appearance: textfield;
    }
    td.value input#termYears::-webkit-outer-spin-button,
    td.value input#termYears::-webkit-inner-spin-button,
    td.value input#comPercent::-webkit-outer-spin-button,
    td.value input#comPercent::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    td.value input::placeholder {
      color: #aaa;
    }

    td.value input:not([readonly]):focus,
    td.value select:focus {
      border-color: var(--orix-logo-blue);
      box-shadow: 0 0 0 0.2rem rgba(0, 51, 102, 0.2);
      outline: none;
    }

    td.value input[readonly] {
      width: 100%;
      padding: 7px 10px; /* Reduced input padding */
      border: 1px solid var(--orix-border-color);
      border-radius: 6px;
      background-color: var(--input-bg-readonly);
      font-weight: bold;
      color: var(--highlight-text-color);
      text-align: right;
      box-sizing: border-box;
      font-size: 1.0em; /* Slightly reduced input font size */
    }

    .button-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px; /* Reduced gap between buttons */
        margin-top: 20px; /* Reduced margin-top for button group */
        margin-bottom: 5px;
        justify-content: center;
    }

    .button-group button {
      flex: 1;
      min-width: 180px; /* Reduced min-width for smaller buttons */
      padding: 12px 15px; /* Reduced button padding */
      font-size: 1.05em; /* Slightly reduced button font size */
      color: var(--orix-white);
      border: none;
      border-radius: 7px; /* Slightly reduced border-radius */
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1); /* Slightly softer shadow */
      text-shadow: 0 1px 1px rgba(0,0,0,0.2); /* Slightly softer text shadow */
      letter-spacing: 0.2px; /* Reduced letter spacing */
    }

    /* ORIX Brand Colors for Buttons (unchanged, as per previous request) */
    .button-group button:nth-of-type(1) { /* คำนวณ - ORIX Blue */
      background: linear-gradient(145deg, #004080, var(--orix-logo-blue));
    }
    .button-group button:nth-of-type(1):hover {
      background: linear-gradient(145deg, var(--orix-logo-blue), #00264d);
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
    }

    .button-group button:nth-of-type(2) { /* ค่างวด 36,000 - ORIX Red */
      background: linear-gradient(145deg, #FF3B49, var(--orix-logo-red));
    }
    .button-group button:nth-of-type(2):hover {
      background: linear-gradient(145deg, var(--orix-logo-red), #B0050D);
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
    }

    .button-group button:nth-of-type(3) { /* สร้างใบเสนอราคา - Secondary Blue (Lighter ORIX Blue) */
      background: linear-gradient(145deg, #005AAB, #00488C);
    }
    .button-group button:nth-of-type(3):hover {
      background: linear-gradient(145deg, #00488C, #00366B);
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
    }

    .button-group button:nth-of-type(4) { /* ส่งข้อมูล QS - Secondary Red (Lighter ORIX Red) */
        background: linear-gradient(145deg, #FF6672, #E65A66);
    }
    .button-group button:nth-of-type(4):hover {
        background: linear<gradient(145deg, #E65A66, #CC4F59);
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
    }

    .button-group button:active {
      transform: translateY(0);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    #downPercentDisplay {
      font-weight: bold;
      color: var(--highlight-text-color);
      font-size: 1.05em;
    }

    /* Responsive adjustments for smaller screens (e.g., mobile phones) */
    @media screen and (max-width: 768px) {
      body {
        padding: 4px;
        font-size: 0.9em; /* Adjusted for better fit */
      }
      .container {
        margin: 4px;
        padding: 10px;
      }

      h1 {
        font-size: 1.6em;
        margin-bottom: 12px;
      }

      h2 {
        font-size: 1.3em;
        margin-top: 15px;
        margin-bottom: 5px;
        padding-bottom: 0;
      }

      table {
        margin-bottom: 6px;
      }

      /* Core change: Make table rows flex containers */
      table tr {
        display: flex;
        align-items: center; /* Vertically align label and input */
        margin-bottom: 6px;
        flex-wrap: wrap; /* Allows wrapping if needed, though unlikely with this setup */
      }
      
      /* Remove block display and set specific widths */
      td {
        padding: 3px 0;
        border-bottom: none;
      }

      td.label {
        width: 40%; /* Allocate 40% width to the label */
        padding-right: 8px; /* Add space between label and input */
        box-sizing: border-box;
        font-weight: 600;
        text-align: left;
      }

      td.value {
        width: 60%; /* Allocate 60% width to the value/input field */
        box-sizing: border-box;
      }

      td.value input:not([readonly]),
      td.value select,
      td.value input[readonly] {
        font-size: 1em; /* Keep font size consistent with body */
        padding: 6px 8px;
        width: 100%; /* Make input fill its container (td.value) */
      }
      
      table tr:last-child {
        border-bottom: none;
      }

      .button-group {
        flex-direction: column;
        gap: 8px;
        margin-top: 15px;
      }
      .button-group button {
        width: 100%;
        min-width: unset;
        padding: 12px;
        font-size: 1em;
      }
    }
  </style>
</head>
<body>

<div class="container">
  <h1>Financial Lease Calculator</h1>

  <h2>ข้อมูลเบื้องต้น</h2>
  <table>
    <tr><td class="label">ข้อมูลรถ</td><td class="value"><input id="carInfo" type="text" value=""></td></tr>
    <tr><td class="label">ราคารถ</td><td class="value"><input id="carPrice" type="text" value="0.00"></td></tr>
    <tr><td class="label">ส่วนลด</td><td class="value"><input id="discount" type="text" value="0.00"></td></tr>
    <tr><td class="label">Option</td><td class="value"><input id="option" type="text" value="0.00"></td></tr>
    <tr><td class="label">ราคาสุทธิ</td><td class="value"><input id="totalAmount" readonly></td></tr>
  </table>

  <h2>เงินดาวน์</h2>
  <table>
    <tr>
      <td class="label">รูปแบบ</td>
      <td class="value">
        <select id="downType" onchange="calculate()">
          <option value="percent">เป็น %</option>
          <option value="amount">เป็นจำนวนเงิน</option>
        </select>
      </td>
    </tr>
    <tr><td class="label">กรอก % หรือ จำนวน</td><td class="value"><input id="downInput" type="text" value="0.00"></td></tr>
    <tr><td class="label">เงินดาวน์</td><td class="value"><input id="downAmount" readonly></td></tr>
    <tr><td class="label">เงินดาวน์คิดเป็น</td><td class="value"><span id="downPercentDisplay">-</span></td></tr>
  </table>

  <h2>ดอกเบี้ยและระยะเวลา</h2>
  <table>
    <tr>
      <td class="label">ประเภทดอกเบี้ย</td>
      <td class="value">
        <select id="rateType" onchange="calculate()">
          <option value="flat">Flat Rate</option>
          <option value="effective">Effective Rate</option>
        </select>
      </td>
    </tr>
    <tr><td class="label">อัตราดอกเบี้ย (%)</td><td class="value"><input id="interestRate" type="text" value="0.00"></td></tr>
    <tr><td class="label">จำนวนปี</td><td class="value"><input id="termYears" type="number" step="1" value="0"></td></tr>
  </table>

  <h2>ค่าคอมมิชชั่น</h2>
  <table>
    <tr><td class="label">คิดค่าคอมจาก</td>
      <td class="value">
        <select id="comBase" onchange="calculate()">
          <option value="interest">ดอกเบี้ยรวม</option>
          <option value="finance">ยอดจัด</option>
        </select>
      </td>
    </tr>
    <tr><td class="label">Commission (%)</td><td class="value"><input id="comPercent" type="number" step="1" value="0"></td></tr>
    <tr><td class="label">ค่าคอม (ที่คำนวณ)</td><td class="value"><input id="calculatedCommission" readonly></td></tr>
    <tr><td class="label">Extra Commission</td><td class="value"><input id="extra" type="text" value="0.00"></td></tr>
    <tr><td class="label">QS Extra Cost</td><td class="value"><input id="qsExtra" readonly></td></tr>
  </table>

  <h2>ผลลัพธ์</h2>
  <table>
    <tr><td class="label">ยอดจัด</td><td class="value"><input id="financeAmt" readonly></td></tr>
    <tr><td class="label">อัตราดอกเบี้ย Flat</td><td class="value"><input id="calculatedFlatRate" readonly></td></tr>
    <tr><td class="label">ดอกเบี้ยต่อปี</td><td class="value"><input id="intPA" readonly></td></tr>
    <tr><td class="label">ดอกเบี้ยรวม</td><td class="value"><input id="intTotal" readonly></td></tr>
    <tr><td class="label">ยอดจัดรวม</td><td class="value"><input id="financeTotalWithInterest" readonly></td></tr>
    <tr><td class="label">ค่างวด (In VAT)</td><td class="value"><input id="leaseInVat" readonly></td></tr>
    <tr><td class="label">ค่างวด (Ex VAT)</td><td class="value"><input id="leaseExVat" readonly></td></tr>
    <tr><td class="label">TR (Effective %)</td><td class="value"><input id="trRate" readonly></td></tr>
  </table>

  <h2>QS Information</h2>
  <table>
    <tr><td class="label">ข้อมูลรถ</td><td class="value"><input id="qsCarInfo" readonly></td></tr>
    <tr><td class="label">ราคารถ</td><td class="value"><input id="qsCarPrice" readonly></td></tr>
    <tr><td class="label">ส่วนลด</td><td class="value"><input id="qsDiscount" readonly></td></tr>
    <tr><td class="label">Option</td><td class="value"><input id="qsOption" readonly></td></tr>
    <tr><td class="label">เงินดาวน์</td><td class="value"><input id="qsDownAmount" readonly></td></tr>
    <tr><td class="label">เงินดาวน์คิดเป็น %</td><td class="value"><input id="qsDownPercent" readonly></td></tr>
    <tr><td class="label">TR (Effective %)</td><td class="value"><input id="qsTrRate" readonly></td></tr>
    <tr><td class="label">จำนวนปี</td><td class="value"><input id="qsTermYears" readonly></td></tr>
    <tr><td class="label">Deposit</td><td class="value"><input id="qsDeposit" readonly></td></tr>
    <tr><td class="label">RV</td><td class="value"><input id="qsRV" readonly></td></tr>
    <tr><td class="label">TR Dep</td><td class="value"><input id="qsTrDep" readonly></td></tr>
  </table>

  <div class="button-group">
    <button onclick="calculate()">คำนวณ</button>
    <button onclick="calculateDownForTargetLease(36000)">ค่างวด 36,000</button>
    <button onclick="generateQuotation()">ใบเสนอราคา</button>
    <button onclick="sendToQsData()">ส่งข้อมูล QS</button>
  </div>
</div>

<script>
// Helper functions for number formatting
function format(n, decimals = 2) {
  if (isNaN(n) || n === null || n === undefined) return "0.00";
  return new Intl.NumberFormat('en-US', {
    minimumFractionDigits: decimals,
    maximumFractionDigits: decimals
  }).format(parseFloat(n));
}

function formatNoDecimal(n) {
  return format(n, 0);
}

function format4(n) {
  if (isNaN(n) || n === null || n === undefined) return "0.0000";
  return new Intl.NumberFormat('en-US', {
    minimumFractionDigits: 4,
    maximumFractionDigits: 4
  }).format(parseFloat(n));
}

function uncomma(s) {
  const cleaned = String(s).replace(/,/g, '');
  const num = parseFloat(cleaned);
  return isNaN(num) ? 0 : num;
}

// IRR Calculation: Solves for the interest rate given cash flows
// nper: Number of periods
// pmt: Payment made each period (negative for outflow)
// pv: Present value (negative for outflow)
// fv: Future value (positive for inflow)
// type: When payments are made (0=end of period, 1=beginning of period)
function calculateIRR(nper, pmt, pv, fv = 0, type = 0) {
  if (pmt === 0 && pv === 0 && fv === 0) return NaN;
  if (nper <= 0) return NaN;

  let guess = 0.05 / 12; // Initial guess for monthly rate
  let rate = guess;
  const maxIter = 500;
  const tol = 1e-7; // Tolerance for convergence

  for (let i = 0; i < maxIter; i++) {
    let f = pv;
    let df = 0;

    // Sum of present values of payments
    for (let t = 1; t <= nper; t++) {
      const discountFactor = Math.pow(1 + rate, t - (type === 1 ? 1 : 0));
      f += pmt / discountFactor;
      df += -(t - (type === 1 ? 1 : 0)) * pmt / Math.pow(1 + rate, t + 1 - (type === 1 ? 1 : 0));
    }
    
    // Add present value of future value (RV)
    f += fv / Math.pow(1 + rate, nper);
    df += -nper * fv / Math.pow(1 + rate, nper + 1);

    if (Math.abs(f) < tol) return rate;

    const newRate = rate - f / df;
    if (Math.abs(newRate - rate) < tol) return newRate;
    if (isNaN(newRate) || !isFinite(newRate)) return NaN; // Check for invalid rates

    rate = newRate;
  }
  return NaN; // No convergence
}

// Function to update down payment percentage display
function showDownPercent() {
  const total = uncomma(document.getElementById("totalAmount").value);
  const down = uncomma(document.getElementById("downAmount").value);
  const result = total > 0 ? (down / total * 100) : 0;
  document.getElementById("downPercentDisplay").innerText = `(${format4(result)}%)`;
  document.getElementById("qsDownPercent").value = format4(result) + '%';
}

// Function to update QS Information section
function updateQsInfo(carInfo, carPrice, discount, option, downAmount, termYears, trRate, trDep, qsExtraCost) {
    // Dep and RV are fixed at 0 or other predefined values
    const displayDeposit = 0; // Display Dep as 0 as per request
    const displayRvPercent = 0; // Display RV as 0% as per request

    document.getElementById('qsCarInfo').value = carInfo;
    document.getElementById('qsCarPrice').value = format(carPrice);
    document.getElementById('qsDiscount').value = format(discount);
    document.getElementById('qsOption').value = format(option);
    document.getElementById('qsDownAmount').value = format(downAmount);
    // qsDownPercent is updated by showDownPercent()
    document.getElementById('qsTrRate').value = isNaN(trRate) ? 'ไม่สามารถคำนวณ' : format4(trRate);
    document.getElementById('qsTermYears').value = termYears;
    document.getElementById('qsDeposit').value = format(displayDeposit); // Fixed value for display
    document.getElementById('qsRV').value = format(displayRvPercent) + '%'; // Fixed value for display
    document.getElementById('qsTrDep').value = isNaN(trDep) ? 'ไม่สามารถคำนวณ' : format4(trDep);
}

// Main calculation function
function calculate() {
  const getVal = id => uncomma(document.getElementById(id).value);
  const getIntVal = id => parseInt(uncomma(document.getElementById(id).value)) || 0;

  const carInfo = document.getElementById('carInfo').value;
  const car = getVal('carPrice');
  const discount = getVal('discount');
  const option = getVal('option');
  const total = car - discount + option;
  document.getElementById('totalAmount').value = format(total);

  const downType = document.getElementById('downType').value;
  const downInput = getVal('downInput');
  let down = 0;
  if (downType === 'percent') {
    down = total * (downInput / 100);
  } else {
    down = downInput;
  }
  document.getElementById('downAmount').value = format(down);

  const finance = total - down;
  const originalInterestRateInput = getVal('interestRate'); 
  const rateType = document.getElementById('rateType').value;
  let actualFlatRate = 0; 
  let leaseInVat = 0; 
  let intTotal = 0; 
  let commission = 0; 
  let qsExtraCost = 0; 

  const years = getIntVal('termYears');
  const months = years * 12;

  // Dep and RV are hardcoded as 0 for calculation and display as per request
  const deposit = 0; 
  const rvPercent = 0; 
  const residualValue = total * (rvPercent / 100); // This will be 0 if rvPercent is 0

  // Handle zero term years
  if (months === 0) {
      document.getElementById('financeAmt').value = format(finance);
      document.getElementById('calculatedFlatRate').value = format(0);
      document.getElementById('intPA').value = format(0);
      document.getElementById('intTotal').value = format(0);
      document.getElementById('financeTotalWithInterest').value = format(finance);
      document.getElementById('calculatedCommission').value = format(0);
      document.getElementById('qsExtra').value = format(0);
      document.getElementById('leaseInVat').value = format(0);
      document.getElementById('leaseExVat').value = format(0);
      document.getElementById('trRate').value = 'ไม่สามารถคำนวณ';
      document.getElementById('qsTrDep').value = 'ไม่สามารถคำนวณ';
      showDownPercent();
      updateQsInfo(carInfo, car, discount, option, down, years, 0, 0, 0); 
      return;
  }

  const comPercent = getIntVal('comPercent');
  const extra = getVal('extra');
  const comBase = document.getElementById('comBase').value;

  if (rateType === 'flat') {
      actualFlatRate = originalInterestRateInput;
      // Flat Rate calculation: Simple Interest based on finance amount
      intTotal = finance * (actualFlatRate / 100) * years;
      const financeTotalWithInterest = finance + intTotal;
      leaseInVat = Math.ceil(financeTotalWithInterest / months); // Total to be paid divided by months
      
      // Commission calculation based on chosen base
      if (comBase === "finance") {
          commission = Math.ceil(finance * (comPercent / 100));
      } else { 
          commission = Math.ceil(intTotal * (comPercent / 100));
      }
      qsExtraCost = commission + extra;

  } else { // Effective Rate (User inputs desired TR)
      const targetTrRate = originalInterestRateInput; 

      let lowLease = 1;
      // High estimate for lease payment (e.g., 5 times the basic principal per month)
      let highLease = (finance * 5) / months; 
      if (highLease < 1000) highLease = 1000000; // Ensure a reasonable upper bound

      let bestLeaseInVatCandidate = 0;
      let bestCommissionCandidate = 0;
      let bestQsExtraCostCandidate = 0;
      let minTrDiff = Infinity;
      const tolerance = 0.00001; // Tolerance for TR convergence

      // Bisection search for LeaseInVat
      for (let i = 0; i < 200; i++) { // Max iterations
          let currentLeaseInVat = Math.round((lowLease + highLease) / 2); 
          if (currentLeaseInVat <= 0) currentLeaseInVat = 1; // Prevent zero or negative payments

          // Temporary interest total based on current lease guess
          const tempIntTotal = (currentLeaseInVat * months) - finance; 
          
          let tempCommission = 0;
          if (comBase === "finance") {
              tempCommission = Math.ceil(finance * (comPercent / 100));
          } else { 
              tempCommission = Math.ceil(tempIntTotal * (comPercent / 100));
          }
          const tempExtraCost = tempCommission + extra;

          // PV for IRR: -(Finance amount + (Commission * 1.07) + (Extra * 1.07))
          // Commission and Extra are cash outflows, so they are added to the principal to be financed.
          const pvForTrCalculation = -(finance + (tempCommission * 1.07) + (extra * 1.07)); 
          // FV is 0 as per the requirement (no RV)
          let calculatedTr = calculateIRR(months, -currentLeaseInVat, pvForTrCalculation, 0, 0) * 12 * 100;
          
          const diff = Math.abs(calculatedTr - targetTrRate);

          // Store the best candidate found so far
          if (diff < minTrDiff) {
              minTrDiff = diff;
              bestLeaseInVatCandidate = currentLeaseInVat;
              bestCommissionCandidate = tempCommission;
              bestQsExtraCostCandidate = tempExtraCost;
          }

          // If close enough, we can stop
          if (diff < tolerance) { 
              break;
          }

          // Adjust search range
          if (calculatedTr > targetTrRate) {
              highLease = currentLeaseInVat; 
          } else {
              lowLease = currentLeaseInVat; 
          }
      }
      
      leaseInVat = bestLeaseInVatCandidate;
      commission = bestCommissionCandidate;
      qsExtraCost = bestQsExtraCostCandidate;

      // Recalculate intTotal and actualFlatRate using the found leaseInVat
      intTotal = (leaseInVat * months) - finance;
      actualFlatRate = (finance > 0 && years > 0) ? (intTotal / finance / years) * 100 : 0;

      if (isNaN(actualFlatRate) || !isFinite(actualFlatRate)) {
        actualFlatRate = 0;
      }
  }

  // Final display calculations
  const intPA = finance * (actualFlatRate / 100);
  const financeTotalWithInterestFinal = finance + intTotal;
  const leaseExVat = leaseInVat / 1.07;

  // Recalculate TR (Effective %) and TR Dep with final commission/qsExtraCost
  // PV for IRR for TR calculation
  const pvForIRR = -(finance + (commission * 1.07) + (extra * 1.07));
  const tr = calculateIRR(months, -leaseInVat, pvForIRR, 0, 0) * 12 * 100; // FV is 0

  // TR Dep: Uses Total Amount as PV and Down Payment as FV (Cash Inflow at start)
  // PV for TR Dep: -(Total Car Amount + (Commission * 1.07) + (Extra * 1.07))
  const pvForTRDep = -(total + (commission * 1.07) + (extra * 1.07));
  const trDep = calculateIRR(months, -leaseInVat, pvForTRDep, down, 0) * 12 * 100; // FV is down payment

  document.getElementById('financeAmt').value = format(finance);
  document.getElementById('calculatedFlatRate').value = format4(actualFlatRate); 
  document.getElementById('intPA').value = format(intPA);
  document.getElementById('intTotal').value = format(intTotal);
  document.getElementById('financeTotalWithInterest').value = format(financeTotalWithInterestFinal);
  document.getElementById('calculatedCommission').value = format(commission);
  document.getElementById('qsExtra').value = format(qsExtraCost);
  document.getElementById('leaseInVat').value = format(leaseInVat);
  document.getElementById('leaseExVat').value = format(leaseExVat);
  document.getElementById('trRate').value = isNaN(tr) ? 'ไม่สามารถคำนวณ' : format4(tr);
  document.getElementById('qsTrDep').value = isNaN(trDep) ? 'ไม่สามารถคำนวณ' : format4(trDep);

  updateQsInfo(carInfo, car, discount, option, down, years, tr, trDep, qsExtraCost);
  showDownPercent();
}

// *** Function to calculate down payment for a target lease amount ***
// This function performs a bisection search to find the down payment
// that results in the targetLease payment.
function calculateDownForTargetLease(targetLease) {
    const getVal = id => uncomma(document.getElementById(id).value);
    const getIntVal = id => parseInt(uncomma(document.getElementById(id).value)) || 0;

    const car = getVal('carPrice');
    const discount = getVal('discount');
    const option = getVal('option');
    const total = car - discount + option;
    document.getElementById('totalAmount').value = format(total);

    const originalInterestRateInput = getVal('interestRate'); 
    const years = getIntVal('termYears');
    const months = years * 12;

    const rateType = document.getElementById('rateType').value;
    const comBase = document.getElementById('comBase').value;     
    const comPercent = getIntVal('comPercent');
    const extra = getVal('extra');

    // Dep and RV are hardcoded as 0 for this specific calculation as well
    const deposit = 0; 
    const rvPercent = 0; 
    const residualValue = 0; // Will be 0

    if (months === 0 || originalInterestRateInput === 0 || total <= 0) {
        alert("กรุณาระบุราคารถ, จำนวนปี และอัตราดอกเบี้ยให้ถูกต้อง (มากกว่า 0) ก่อนคำนวณเงินดาวน์สำหรับค่างวดเป้าหมาย.");
        return;
    }

    let lowDown = 0;
    let highDown = total; // Max possible down payment is the total car price
    let bestDown = 0;
    let minLeaseDiff = Infinity; // Track the smallest difference from the target lease

    const maxIter = 200; // Max iterations for bisection search
    const tolerance = 0.5; // Acceptable difference for the lease payment (e.g., +/- 0.5 Baht)

    for (let i = 0; i < maxIter; i++) {
        const currentDown = Math.round((lowDown + highDown) / 2); // Midpoint of the current search range
        
        // Ensure down payment is within valid bounds
        if (currentDown < 0) {
            lowDown = 0; // If somehow negative, reset low bound
            continue;
        }
        if (currentDown > total) {
            highDown = total; // If somehow exceeds total, reset high bound
            continue;
        }

        const finance = total - currentDown; // Calculate finance amount for current down payment

        let currentLeaseInVat = 0;
        let currentCommission = 0;
        let intTotalForCommissionCalc = 0; 

        if (rateType === 'flat') {
            // Flat Rate: Calculate interest and lease payment directly
            intTotalForCommissionCalc = finance * (originalInterestRateInput / 100) * years;
            currentLeaseInVat = Math.ceil((finance + intTotalForCommissionCalc) / months); 
            
            // Calculate commission based on the determined interest total or finance amount
            if (comBase === "finance") {
                currentCommission = Math.ceil(finance * (comPercent / 100));
            } else {
                currentCommission = Math.ceil(intTotalForCommissionCalc * (comPercent / 100));
            }

        } else { // Effective Rate: Use inner bisection search to find lease for this down payment
            const targetTrRateForThisIteration = originalInterestRateInput;
            
            let innerLowLease = 1;
            let innerHighLease = (total * 5) / months; 
            if (innerHighLease < 1000) innerHighLease = 1000000;

            let bestInnerLease = 0;
            let minInnerTrDiff = Infinity;
            const innerTolerance = 0.0001; 

            for (let j = 0; j < 100; j++) {
                let tempLeaseCandidate = Math.round((innerLowLease + innerHighLease) / 2);
                if (tempLeaseCandidate <= 0) tempLeaseCandidate = 1;

                const tempIntTotal = (tempLeaseCandidate * months) - finance; 
                
                let tempInnerCommission = 0;
                if (comBase === "finance") {
                    tempInnerCommission = Math.ceil(finance * (comPercent / 100));
                } else {
                    tempInnerCommission = Math.ceil(tempIntTotal * (comPercent / 100));
                }
                
                // PV for IRR: -(Finance + (tempCommission * 1.07) + (extra * 1.07))
                const pvForInnerTr = -(finance + (tempInnerCommission * 1.07) + (extra * 1.07));
                let calculatedInnerTr = calculateIRR(months, -tempLeaseCandidate, pvForInnerTr, 0, 0) * 12 * 100;
                
                const innerDiff = Math.abs(calculatedInnerTr - targetTrRateForThisIteration);

                if (innerDiff < minInnerTrDiff) {
                    minInnerTrDiff = innerDiff;
                    bestInnerLease = tempLeaseCandidate;
                    currentCommission = tempInnerCommission; 
                }

                if (innerDiff < innerTolerance) {
                    break;
                }

                if (calculatedInnerTr > targetTrRateForThisIteration) {
                    innerHighLease = tempLeaseCandidate;
                } else {
                    innerLowLease = tempLeaseCandidate;
                }
            }
            currentLeaseInVat = bestInnerLease;
        }

        // Compare the calculated lease payment with the target lease
        const diff = Math.abs(currentLeaseInVat - targetLease);

        if (diff < minLeaseDiff) { // If this is the best match so far
            minLeaseDiff = diff;
            bestDown = currentDown;
        }

        if (diff < tolerance) { // If we are within acceptable tolerance
            break;
        }

        // Adjust search range for down payment
        if (currentLeaseInVat > targetLease) {
            lowDown = currentDown; // If current lease is too high, need to increase down payment
        } else {
            highDown = currentDown; // If current lease is too low, can decrease down payment
        }
    }
    
    // Update UI with the found down payment and recalculate all values
    document.getElementById('downType').value = 'amount'; // Set down type to amount
    document.getElementById('downInput').value = formatNoDecimal(bestDown); // Set the found down amount
    calculate(); // Trigger a full recalculation based on the new down payment
}


// Function to generate quotation (for quotation.html)
function generateQuotation() {
    calculate(); // Ensure all values are up-to-date

    // Dep and RV values are fixed as 0 for quotation data
    const depositValue = 0;
    const rvPercentValue = 0;
    
    const data = {
        carInfo: document.getElementById('carInfo').value,
        carPrice: uncomma(document.getElementById('carPrice').value),
        discount: uncomma(document.getElementById('discount').value),
        option: uncomma(document.getElementById('option').value),
        totalAmount: uncomma(document.getElementById('totalAmount').value),
        downAmount: uncomma(document.getElementById('downAmount').value),
        downPercent: parseFloat(document.getElementById('downPercentDisplay').innerText.replace(/[()%]/g, '')),
        
        rateType: document.getElementById('rateType').value,
        interestRateInput: uncomma(document.getElementById('interestRate').value),
        calculatedFlatRate: uncomma(document.getElementById('calculatedFlatRate').value),
        termYears: parseInt(document.getElementById('termYears').value) || 0,
        deposit: depositValue, 
        rvPercent: rvPercentValue, 
        
        comBase: document.getElementById('comBase').value,
        comPercent: parseInt(document.getElementById('comPercent').value) || 0,
        calculatedCommission: uncomma(document.getElementById('calculatedCommission').value),
        extra: uncomma(document.getElementById('extra').value),
        qsExtra: uncomma(document.getElementById('qsExtra').value),

        financeAmt: uncomma(document.getElementById('financeAmt').value),
        intPA: uncomma(document.getElementById('intPA').value),
        intTotal: uncomma(document.getElementById('intTotal').value),
        financeTotalWithInterest: uncomma(document.getElementById('financeTotalWithInterest').value),
        leaseInVat: uncomma(document.getElementById('leaseInVat').value),
        leaseExVat: uncomma(document.getElementById('leaseExVat').value),
        trRate: parseFloat(document.getElementById('trRate').value.replace('ไม่สามารถคำนวณ', 'NaN')),
        
        // QS Information values
        qsCarInfo: document.getElementById('qsCarInfo').value,
        qsCarPrice: uncomma(document.getElementById('qsCarPrice').value),
        qsDiscount: uncomma(document.getElementById('qsDiscount').value),
        qsOption: uncomma(document.getElementById('qsOption').value),
        qsDownAmount: uncomma(document.getElementById('qsDownAmount').value),
        qsDownPercent: parseFloat(document.getElementById('qsDownPercent').value.replace(/[()%]/g, '')),
        qsTrRate: parseFloat(document.getElementById('qsTrRate').value.replace('ไม่สามารถคำนวณ', 'NaN')),
        qsTermYears: parseInt(document.getElementById('qsTermYears').value) || 0,
        qsDeposit: depositValue,
        qsRV: rvPercentValue,
        qsTrDep: parseFloat(document.getElementById('qsTrDep').value.replace('ไม่สามารถคำนวณ', 'NaN')),
    };

    localStorage.setItem('quotationData', JSON.stringify(data));
    window.open('quotation.html', '_blank');
}

// Function to send data to QS (for qs_data.html)
function sendToQsData() {
    calculate(); 

    // Dep and RV values are fixed as 0 for QS data
    const depositValue = 0;
    const rvPercentValue = 0;

    const qsExtraCost = uncomma(document.getElementById('qsExtra').value);
    const downAmount = uncomma(document.getElementById('downAmount').value);
    const totalAmount = uncomma(document.getElementById('totalAmount').value);
    const trRateEffective = parseFloat(document.getElementById('trRate').value.replace('ไม่สามารถคำนวณ', 'NaN'));
    const termYears = parseInt(document.getElementById('termYears').value) || 0;
    const trDep = parseFloat(document.getElementById('qsTrDep').value.replace('ไม่สามารถคำนวณ', 'NaN'));
    const downPercent = parseFloat(document.getElementById('downPercentDisplay').innerText.replace(/[()%]/g, ''));
    const leaseExVat = uncomma(document.getElementById('leaseExVat').value);


    const dataForQs = {
        carInfo: document.getElementById('carInfo').value,
        carPrice: uncomma(document.getElementById('carPrice').value),
        discount: uncomma(document.getElementById('discount').value),
        option: uncomma(document.getElementById('option').value),
        totalAmount: totalAmount,
        qsExtraCost: qsExtraCost,
        downAmount: downAmount,
        qsDownPercent: downPercent,
        trRateEffective: trRateEffective,
        termYears: termYears,
        deposit: depositValue, 
        rv: rvPercentValue, 
        trDep: trDep,
        leaseExVat: leaseExVat
    };

    localStorage.setItem('qsData', JSON.stringify(dataForQs)); 
    window.open('qs_data.html', '_blank');
}


// Event Listeners for input fields to trigger calculations on blur and format on focus/blur
function addInputListeners(id) {
  const el = document.getElementById(id);

  if (id === 'carInfo') {
      el.addEventListener('blur', calculate);
  } else { 
      el.addEventListener('focus', () => {
          let currentVal = uncomma(el.value);
          // Clear "0.00" on focus for easier input, but keep actual numbers
          if (Math.abs(currentVal) < 0.001) {
              el.value = ''; 
          } else {
              el.value = String(currentVal); 
          }
      });
      el.addEventListener('blur', () => {
          let val = uncomma(el.value);
          // Format based on input type
          if (id === 'termYears' || id === 'comPercent') {
              el.value = formatNoDecimal(val);
          } else if (id === 'interestRate') { 
              el.value = format(val, 2); // Interest rate often needs 2 decimal places
          }
          else {
              el.value = format(val); // Default to 2 decimal places
          }
          calculate(); // Recalculate after input is finalized
      });
      el.addEventListener('input', () => {
          // Live sanitization of input to allow only numbers and one decimal point
          let sanitizedValue = el.value.replace(/[^0-9.]/g, '');
          const parts = sanitizedValue.split('.');
          if (parts.length > 2) {
              sanitizedValue = parts[0] + '.' + parts.slice(1).join(''); // Allow only one decimal
          }
          el.value = sanitizedValue;
      });
  }
}

// Initialize on page load
window.onload = () => {
  // Attach event listeners to all relevant input fields
  ['carPrice', 'discount', 'option', 'downInput', 'interestRate', 'extra', 'termYears', 'comPercent', 'carInfo'].forEach(addInputListeners);
  
  // Attach change listeners to select elements
  document.getElementById('downType').addEventListener('change', calculate);
  document.getElementById('comBase').addEventListener('change', calculate);
  document.getElementById('rateType').addEventListener('change', calculate); 
  
  // Perform initial calculation on page load
  calculate(); 
};
</script>

</body>
</html>
